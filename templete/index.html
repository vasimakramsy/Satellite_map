<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Satellite Agent Map Chat</title>
    <style>
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #chat-container {
            width: 30%;
            padding: 10px;
            background: rgba(245, 245, 245, 0.6);
            display: flex;
            flex-direction: column;
            position: absolute;
            right: 0;
            height: 100vh;
            backdrop-filter: blur(8px);
            border-left: 2px solid rgba(255, 255, 255, 0.3);
        }

        #map-container { width: 100%; height: 100vh; position: relative; }
        #map { width: 100%; height: 100vh; }

        #search-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            width: 300px;
            z-index: 10;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: transparent;
        }

        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .user {
            background: rgba(255, 255, 255, 0.8);
            text-align: left;
            color: #333;
        }

        .assistant {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            text-align: right;
        }

        #chat-input {
            display: flex;
            padding: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.7);
        }

        button {
            margin-left: 10px;
            padding: 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        h2 {
            display: block;
            font-size: 1.5em;
            margin-top: 0.83em;
            margin-bottom: 0.83em;
            margin-left: 0;
            margin-right: 0;
            font-weight: bold;
            color: blue;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <input id="search-box" type="text" placeholder="Search location...">
        <div id="map"></div>
    </div>

    <div id="chat-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>SATELLITE AGENT</h2>
            <div>
                <button onclick="location.reload()" style="padding: 6px 12px; font-size: 14px;">New Session</button>
                <button id="delete-btn" onclick="deleteBBox()" style="padding: 6px 12px; font-size: 14px; display: none; margin-left: 10px;">Delete Area</button>
            </div>
        </div>
        <div id="messages"></div>
        <div id="chat-input">
            <input type="text" id="message-box" placeholder="Type a message">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let map, drawingManager, selectedRectangle = null;
        let bboxCoords = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 24.7136, lng: 46.6753 },
                zoom: 15,
                mapTypeId: "satellite",
                mapTypeControl: false
            });

            const searchBox = new google.maps.places.SearchBox(document.getElementById("search-box"));
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById("search-box"));

            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;
                map.setCenter(places[0].geometry.location);
                map.setZoom(15);
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ["rectangle"]
                },
                rectangleOptions: {
                    fillColor: "#FF0000",
                    fillOpacity: 0.3,
                    strokeWeight: 2,
                    clickable: false,
                    editable: true,
                    zIndex: 1
                }
            });

            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedRectangle) {
                    selectedRectangle.setMap(null);
                }

                selectedRectangle = event.overlay;

                const bounds = selectedRectangle.getBounds();
                bboxCoords = {
                    north: bounds.getNorthEast().lat(),
                    east: bounds.getNorthEast().lng(),
                    south: bounds.getSouthWest().lat(),
                    west: bounds.getSouthWest().lng()
                };

                // Disable further drawing after one rectangle
                drawingManager.setDrawingMode(null);

                // Show delete button
                document.getElementById("delete-btn").style.display = "inline-block";
            });
        }

        function deleteBBox() {
            if (selectedRectangle) {
                selectedRectangle.setMap(null);
                selectedRectangle = null;
                bboxCoords = null;
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.RECTANGLE);
                document.getElementById("delete-btn").style.display = "none";
            }
        }

        function captureMapImage(message) {
            if (!bboxCoords) {
                alert("Please select a bounding box first!");
                return;
            }

            const apiKey = "AIzaSyC39DPK0MwCiJOmBIzTmX30IPg6kWeWW44";
            const mapCenter = `${(bboxCoords.north + bboxCoords.south) / 2},${(bboxCoords.east + bboxCoords.west) / 2}`;
            const zoom = 15;
            const mapSize = "600x400";
            const bboxOverlay = `&path=color:0xff0000ff|weight:5|${bboxCoords.north},${bboxCoords.west}|${bboxCoords.north},${bboxCoords.east}|${bboxCoords.south},${bboxCoords.east}|${bboxCoords.south},${bboxCoords.west}|${bboxCoords.north},${bboxCoords.west}`;

            const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${mapCenter}&zoom=${zoom}&size=${mapSize}&maptype=satellite${bboxOverlay}&key=${apiKey}`;

            fetch(staticMapUrl)
                .then(response => response.blob())
                .then(blob => {
                    let formData = new FormData();
                    formData.append("image", blob, "map_capture.png");
                    formData.append("bbox", JSON.stringify(bboxCoords));
                    formData.append("message", message);

                    fetch("/process", {
                        method: "POST",
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => displayResponse(data))
                    .catch(error => console.error("Error:", error));
                })
                .catch(error => console.error("Error fetching static map:", error));
        }

        function sendMessage() {
            let messageBox = document.getElementById("message-box");
            let message = messageBox.value.trim();

            if (!selectedRectangle) {
                alert("Please select an area on the map first!");
                return;
            }

            if (!message) {
                alert("Please enter a message!");
                return;
            }

            captureMapImage(message);
        }

        function displayResponse(data) {
            let messagesDiv = document.getElementById("messages");

            let userMessage = document.createElement("div");
            userMessage.classList.add("message", "user");
            userMessage.textContent = "USER: " + data.message;
            messagesDiv.appendChild(userMessage);

            let assistantMessage = document.createElement("div");
            assistantMessage.classList.add("message", "assistant");
            assistantMessage.textContent = "ASSISTANT: " + data.response;
            messagesDiv.appendChild(assistantMessage);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        window.initMap = initMap;
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC39DPK0MwCiJOmBIzTmX30IPg6kWeWW44&libraries=places,drawing&callback=initMap"></script>
</body>
</html>
